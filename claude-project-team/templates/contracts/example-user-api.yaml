# Interface Contract: User API
# 회원 도메인이 제공하는 API 스펙

domain: user
version: 1.2.0
owner: user-pl
updated: 2026-02-07

description: |
  회원 가입, 인증, 프로필 관리 등 사용자 관련 핵심 기능을 제공하는 API.
  JWT 기반 인증을 사용하며, OAuth 2.0을 통한 소셜 로그인도 지원합니다.

provider:
  domain: user
  team: user-pl
  contact: domains/user/README.md

consumers:
  - domain: order
    endpoints:
      - GET /api/users/{id}
      - GET /api/users/me
    events:
      - user.created
      - user.updated
    since: v1.0.0
  - domain: product
    endpoints:
      - GET /api/users/{id}
    events:
      - user.created
    since: v1.0.0
  - domain: notification
    endpoints:
      - GET /api/users/{id}
    events:
      - user.created
      - user.updated
      - user.deleted
    since: v1.1.0

endpoints:
  # 회원가입
  - path: /api/users/register
    method: POST
    description: 신규 사용자 회원가입

    auth:
      required: false

    request:
      headers:
        Content-Type: "application/json"

      body:
        email:
          type: string
          required: true
          description: "사용자 이메일 (고유 식별자)"
          constraints:
            pattern: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
        password:
          type: string
          required: true
          description: "비밀번호 (최소 8자, 영문+숫자+특수문자)"
          constraints:
            minLength: 8
            pattern: "^(?=.*[A-Za-z])(?=.*\\d)(?=.*[@$!%*#?&])[A-Za-z\\d@$!%*#?&]{8,}$"
        name:
          type: string
          required: true
          description: "사용자 이름"
          constraints:
            minLength: 2
            maxLength: 50
        phone:
          type: string
          required: false
          description: "전화번호 (선택사항)"
          constraints:
            pattern: "^01[0-9]-[0-9]{3,4}-[0-9]{4}$"
        terms_agreed:
          type: boolean
          required: true
          description: "이용약관 동의 여부"

    response:
      201:
        description: "회원가입 성공"
        content:
          user:
            type: object
            properties:
              id:
                type: string
                format: uuid
              email:
                type: string
              name:
                type: string
              grade:
                type: string
                enum: [BASIC, VIP, VVIP]
                default: BASIC
              created_at:
                type: string
                format: datetime
          token:
            type: object
            properties:
              access_token:
                type: string
                description: "JWT 액세스 토큰 (유효기간: 1시간)"
              refresh_token:
                type: string
                description: "리프레시 토큰 (유효기간: 7일)"
              expires_in:
                type: integer
                description: "액세스 토큰 만료 시간 (초)"
                default: 3600

      400:
        error: "Bad Request"
        message: "Invalid input data"
        details:
          - field: "email"
            error: "Invalid email format"

      409:
        error: "Conflict"
        message: "User already exists with this email"

      422:
        error: "Unprocessable Entity"
        message: "Validation failed"
        details:
          - field: "password"
            error: "Password must be at least 8 characters with letters, numbers, and special characters"
          - field: "terms_agreed"
            error: "Must agree to terms of service"

  # 로그인
  - path: /api/users/login
    method: POST
    description: 이메일/비밀번호 기반 로그인

    auth:
      required: false

    request:
      headers:
        Content-Type: "application/json"

      body:
        email:
          type: string
          required: true
          description: "등록된 이메일"
        password:
          type: string
          required: true
          description: "비밀번호"
        remember_me:
          type: boolean
          required: false
          default: false
          description: "로그인 유지 여부 (리프레시 토큰 유효기간 30일로 연장)"

    response:
      200:
        description: "로그인 성공"
        content:
          user:
            type: object
            properties:
              id: string
              email: string
              name: string
              grade: string
              last_login_at: datetime
          token:
            type: object
            properties:
              access_token: string
              refresh_token: string
              expires_in: integer

      401:
        error: "Unauthorized"
        message: "Invalid email or password"

      429:
        error: "Too Many Requests"
        message: "Too many login attempts. Please try again in 15 minutes."

    rate_limit:
      requests: 5
      window: "15m"

  # 로그아웃
  - path: /api/users/logout
    method: POST
    description: 현재 세션 로그아웃 (토큰 무효화)

    auth:
      required: true
      type: Bearer

    request:
      headers:
        Authorization: "Bearer {access_token}"
        Content-Type: "application/json"

      body:
        refresh_token:
          type: string
          required: true
          description: "무효화할 리프레시 토큰"

    response:
      204:
        description: "로그아웃 성공 (본문 없음)"

      401:
        error: "Unauthorized"
        message: "Invalid or expired token"

  # 토큰 갱신
  - path: /api/users/refresh
    method: POST
    description: 리프레시 토큰으로 새 액세스 토큰 발급

    auth:
      required: false

    request:
      headers:
        Content-Type: "application/json"

      body:
        refresh_token:
          type: string
          required: true
          description: "유효한 리프레시 토큰"

    response:
      200:
        description: "토큰 갱신 성공"
        content:
          access_token:
            type: string
          refresh_token:
            type: string
          expires_in:
            type: integer

      401:
        error: "Unauthorized"
        message: "Invalid or expired refresh token"

  # 현재 사용자 정보 조회
  - path: /api/users/me
    method: GET
    description: 인증된 사용자 본인의 정보 조회

    auth:
      required: true
      type: Bearer
      scopes: [user:read]

    request:
      headers:
        Authorization: "Bearer {access_token}"

    response:
      200:
        description: "사용자 정보 조회 성공"
        content:
          id: string
          email: string
          name: string
          phone: string
          grade: string
          email_verified: boolean
          created_at: datetime
          updated_at: datetime
          last_login_at: datetime

      401:
        error: "Unauthorized"
        message: "Authentication required"

    caching:
      enabled: true
      ttl: 300  # 5분
      strategy: "private"

  # 특정 사용자 정보 조회 (타 도메인용)
  - path: /api/users/{id}
    method: GET
    description: 특정 사용자의 공개 정보 조회 (타 도메인에서 사용)

    auth:
      required: true
      type: Bearer
      scopes: [user:read]

    request:
      headers:
        Authorization: "Bearer {access_token}"

      params:
        id:
          type: string
          format: uuid
          required: true
          description: "사용자 ID"

    response:
      200:
        description: "사용자 정보 조회 성공"
        content:
          id: string
          email: string
          name: string
          grade: string
          created_at: datetime

      401:
        error: "Unauthorized"
        message: "Authentication required"

      404:
        error: "User not found"
        message: "User with the specified ID does not exist"

    caching:
      enabled: true
      ttl: 600  # 10분
      strategy: "private"

  # 프로필 업데이트
  - path: /api/users/{id}
    method: PATCH
    description: 사용자 프로필 정보 수정 (본인만 가능)

    auth:
      required: true
      type: Bearer
      scopes: [user:write]

    request:
      headers:
        Authorization: "Bearer {access_token}"
        Content-Type: "application/json"

      params:
        id:
          type: string
          format: uuid
          required: true
          description: "사용자 ID (본인 ID만 허용)"

      body:
        name:
          type: string
          required: false
          constraints:
            minLength: 2
            maxLength: 50
        phone:
          type: string
          required: false
          constraints:
            pattern: "^01[0-9]-[0-9]{3,4}-[0-9]{4}$"

    response:
      200:
        description: "프로필 업데이트 성공"
        content:
          id: string
          email: string
          name: string
          phone: string
          grade: string
          updated_at: datetime

      401:
        error: "Unauthorized"
        message: "Authentication required"

      403:
        error: "Forbidden"
        message: "Cannot update other user's profile"

      404:
        error: "User not found"
        message: "User with the specified ID does not exist"

      422:
        error: "Unprocessable Entity"
        message: "Validation failed"
        details:
          - field: "phone"
            error: "Invalid phone number format"

  # 비밀번호 변경
  - path: /api/users/{id}/password
    method: PUT
    description: 사용자 비밀번호 변경

    auth:
      required: true
      type: Bearer
      scopes: [user:write]

    request:
      headers:
        Authorization: "Bearer {access_token}"
        Content-Type: "application/json"

      params:
        id:
          type: string
          format: uuid
          required: true

      body:
        current_password:
          type: string
          required: true
          description: "현재 비밀번호"
        new_password:
          type: string
          required: true
          description: "새 비밀번호"
          constraints:
            minLength: 8
            pattern: "^(?=.*[A-Za-z])(?=.*\\d)(?=.*[@$!%*#?&])[A-Za-z\\d@$!%*#?&]{8,}$"

    response:
      204:
        description: "비밀번호 변경 성공"

      401:
        error: "Unauthorized"
        message: "Current password is incorrect"

      403:
        error: "Forbidden"
        message: "Cannot change other user's password"

      422:
        error: "Unprocessable Entity"
        message: "New password does not meet requirements"

  # 회원 탈퇴
  - path: /api/users/{id}
    method: DELETE
    description: 사용자 계정 삭제 (soft delete)

    auth:
      required: true
      type: Bearer
      scopes: [user:delete]

    request:
      headers:
        Authorization: "Bearer {access_token}"
        Content-Type: "application/json"

      params:
        id:
          type: string
          format: uuid
          required: true

      body:
        password:
          type: string
          required: true
          description: "본인 확인용 비밀번호"
        reason:
          type: string
          required: false
          description: "탈퇴 사유 (선택사항)"

    response:
      204:
        description: "계정 삭제 성공"

      401:
        error: "Unauthorized"
        message: "Invalid password"

      403:
        error: "Forbidden"
        message: "Cannot delete other user's account"

      404:
        error: "User not found"
        message: "User with the specified ID does not exist"

  # 사용자 목록 조회 (관리자용)
  - path: /api/users
    method: GET
    description: 사용자 목록 조회 (관리자 전용, 페이지네이션 지원)

    auth:
      required: true
      type: Bearer
      scopes: [admin:read]

    request:
      headers:
        Authorization: "Bearer {access_token}"

      query:
        page:
          type: integer
          default: 1
          min: 1
          description: "페이지 번호"
        limit:
          type: integer
          default: 20
          min: 1
          max: 100
          description: "페이지당 항목 수"
        grade:
          type: string
          enum: [BASIC, VIP, VVIP]
          required: false
          description: "등급 필터"
        search:
          type: string
          required: false
          description: "이름/이메일 검색"

    response:
      200:
        description: "사용자 목록 조회 성공"
        content:
          users:
            type: array
            items:
              type: object
              properties:
                id: string
                email: string
                name: string
                grade: string
                created_at: datetime
          pagination:
            type: object
            properties:
              page: integer
              limit: integer
              total: integer
              total_pages: integer

      401:
        error: "Unauthorized"
        message: "Authentication required"

      403:
        error: "Forbidden"
        message: "Admin access required"

    pagination:
      type: "offset"
      max_limit: 100

    caching:
      enabled: true
      ttl: 60  # 1분
      strategy: "private"

# Events
events:
  - name: user.created
    description: 새 사용자 계정이 생성됨
    trigger: "회원가입 성공 시"

    payload:
      id:
        type: string
        required: true
        description: "사용자 ID"
      email:
        type: string
        required: true
        description: "사용자 이메일"
      name:
        type: string
        required: true
        description: "사용자 이름"
      grade:
        type: string
        required: true
        description: "사용자 등급"
      created_at:
        type: string
        format: datetime
        required: true
        description: "생성 시간"

    subscribers:
      - domain: order
        handler: "주문 도메인 사용자 데이터 동기화"
      - domain: notification
        handler: "환영 이메일 발송"

  - name: user.updated
    description: 사용자 정보가 업데이트됨
    trigger: "프로필 수정 성공 시"

    payload:
      id:
        type: string
        required: true
        description: "사용자 ID"
      changes:
        type: object
        required: true
        description: "변경된 필드들"
      updated_at:
        type: string
        format: datetime
        required: true

    subscribers:
      - domain: order
        handler: "주문 도메인 사용자 정보 갱신"
      - domain: notification
        handler: "프로필 변경 알림"

  - name: user.deleted
    description: 사용자 계정이 삭제됨
    trigger: "회원 탈퇴 성공 시"

    payload:
      id:
        type: string
        required: true
        description: "삭제된 사용자 ID"
      deleted_at:
        type: string
        format: datetime
        required: true

    subscribers:
      - domain: order
        handler: "관련 주문 데이터 익명화"
      - domain: notification
        handler: "알림 구독 취소"

  - name: user.grade_changed
    description: 사용자 등급이 변경됨 (v1.2.0에서 추가)
    trigger: "관리자가 등급 변경 시 또는 자동 승급/강등"

    payload:
      id:
        type: string
        required: true
      old_grade:
        type: string
        required: true
      new_grade:
        type: string
        required: true
      changed_at:
        type: string
        format: datetime
        required: true

    subscribers:
      - domain: order
        handler: "할인율 재계산"

# Error Codes
error_codes:
  400: "Bad Request - 잘못된 요청 형식 또는 파라미터"
  401: "Unauthorized - 인증 정보 없음, 만료, 또는 잘못된 인증 정보"
  403: "Forbidden - 권한 없음 (본인 리소스만 접근 가능)"
  404: "Not Found - 사용자를 찾을 수 없음"
  409: "Conflict - 이메일 중복 등 리소스 충돌"
  422: "Unprocessable Entity - 유효성 검증 실패 (비밀번호 형식, 필수 필드 등)"
  429: "Too Many Requests - 로그인 시도 횟수 초과"
  500: "Internal Server Error - 서버 내부 오류"
  503: "Service Unavailable - 인증 서비스 일시 중단"

# Changelog
changelog:
  - version: 1.2.0
    date: 2026-02-07
    type: minor
    breaking: false
    changes:
      - "grade 필드 추가 (BASIC, VIP, VVIP)"
      - "user.grade_changed 이벤트 추가"
      - "사용자 목록 조회 시 grade 필터 지원"
    migration:
      required: true
      guide: "docs/migrations/v1.2.0.md"
    requested_by: order
    approved_by: chief-architect

  - version: 1.1.0
    date: 2026-01-15
    type: minor
    breaking: false
    changes:
      - "전화번호 필드 추가 (선택사항)"
      - "비밀번호 변경 API 추가"
      - "사용자 목록 조회 API 추가 (관리자 전용)"
    migration:
      required: false
    requested_by: user
    approved_by: user-pl

  - version: 1.0.0
    date: 2026-01-01
    type: major
    breaking: false
    changes:
      - "초기 버전 릴리스"
      - "회원가입, 로그인, 로그아웃, 토큰 갱신 API"
      - "프로필 조회/수정/삭제 API"
      - "user.created, user.updated, user.deleted 이벤트"
    migration:
      required: false
    requested_by: user
    approved_by: chief-architect

# Compatibility Policy
compatibility:
  versioning: semantic

  breaking_changes:
    - "필수 필드 추가 (예: 새로운 required: true 필드)"
    - "응답 필드 제거"
    - "필드 타입 변경 (예: string → number)"
    - "엔드포인트 경로 변경"
    - "인증 방식 변경"

  deprecation:
    notice_period: 30 days
    support_period: 90 days

  backward_compatibility:
    policy: "minor/patch 버전은 하위 호환 보장"
    duration: "최소 1개 major 버전 (예: v2 릴리스 후 v1은 6개월 지원)"

# SLA
sla:
  availability: 99.9%
  response_time:
    p50: 80ms
    p95: 300ms
    p99: 800ms
  error_rate: < 0.1%

# Documentation Links
documentation:
  overview: "docs/user/API_OVERVIEW.md"
  guides:
    - "docs/user/guides/authentication.md"
    - "docs/user/guides/user-management.md"
  examples: "docs/user/examples/"
  postman: "docs/user/postman_collection.json"

# Notes
notes: |
  ## 사용 가이드

  ### 인증 흐름
  1. **회원가입/로그인**: access_token + refresh_token 발급
  2. **API 호출**: Authorization: Bearer {access_token} 헤더 사용
  3. **토큰 만료**: refresh_token으로 새 access_token 발급
  4. **로그아웃**: refresh_token 무효화

  ### 권한 스코프
  - `user:read`: 사용자 정보 조회
  - `user:write`: 사용자 정보 수정
  - `user:delete`: 사용자 계정 삭제
  - `admin:read`: 관리자 조회 권한
  - `admin:write`: 관리자 수정 권한

  ### Grade 필드 사용 (v1.2.0)
  - **BASIC**: 신규 가입 시 기본값
  - **VIP**: 주문 금액 100만원 이상 시 자동 승급
  - **VVIP**: 주문 금액 500만원 이상 시 자동 승급
  - 주문 도메인에서 grade에 따라 할인율 적용

  ### 변경 요청 프로세스
  1. 요청 도메인 PL이 `requests/to-user/` 디렉토리에 요청서 작성
  2. user-pl 검토
  3. Breaking change인 경우 chief-architect 승인 필요
  4. user-designer가 interface contract 업데이트
  5. interface-validator 훅 자동 검증
  6. cross-domain-notifier가 영향받는 도메인에 알림

  ### 주의사항
  - 비밀번호는 항상 bcrypt로 해싱하여 저장
  - JWT secret은 환경 변수로 관리
  - Rate limiting은 IP 기반
  - 탈퇴는 soft delete (30일 후 완전 삭제)
  - 개인정보는 암호화 저장 권장
