# ADR-001: API 인증 방식으로 JWT 도입

**상태**: Accepted
**작성자**: chief-architect
**작성일**: 2026-02-05
**승인자**: Chief Architect
**승인일**: 2026-02-07

---

## 컨텍스트

프로젝트 팀 에이전트 아키텍처에서 여러 도메인의 API들이 상호작용합니다. 각 도메인의 API에 접근할 때 안전하고 확장 가능한 인증 메커니즘이 필요합니다.

### 문제 상황
- 현재 프로젝트는 도메인별로 독립적인 API 서버를 운영하고 있습니다
- 도메인 간 API 호출 시 인증이 필요하지만, 표준화된 방식이 없습니다
- 회원 도메인, 주문 도메인, 상품 도메인 등 여러 도메인이 서로 상호작용해야 합니다
- Session 기반 인증은 마이크로서비스 환경에 부적합합니다
- API 게이트웨이 도입 전에 도메인 간 신뢰할 수 있는 인증 메커니즘이 필요합니다

### 영향 범위
- 모든 도메인의 API 엔드포인트 (회원, 주문, 상품, 결제 등)
- 도메인 간 API 호출 (예: 주문 도메인 → 상품 도메인)
- 외부 클라이언트 (웹/모바일 앱) 인증
- QA 자동화 테스트 인증
- 시스템 간 통신 (예: 배치 작업)

---

## 고려한 옵션

### 옵션 1: Session 기반 인증

**설명**
서버에서 세션을 생성하고 세션 ID를 클라이언트에 전달하는 전통적 방식입니다. 대부분의 웹 프레임워크에서 기본으로 지원합니다.

**장점**
- 구현이 간단함
- 기존 프레임워크 지원
- 서버에서 세션 무효화 즉시 가능

**단점**
- 마이크로서비스 환경에서 세션 공유 어려움
- 수평 확장 시 세션 스토어(Redis 등) 필수
- 도메인 간 세션 신뢰 메커니즘 부재
- 상태 유지 필요 (stateful)

**선택하지 않은 이유**
프로젝트 팀 아키텍처는 도메인별 독립 운영을 권장하고 있으며, Session 기반 인증은 이에 맞지 않습니다. 또한 도메인 간 신뢰 메커니즘을 자체 구현해야 하므로 복잡도가 증가합니다.

---

### 옵션 2: OAuth 2.0 (중앙 인증 서버)

**설명**
중앙 인증 서버를 구축하여 모든 도메인이 이를 통해 인증하는 방식입니다. 많은 엔터프라이즈에서 사용합니다.

**장점**
- 업계 표준
- 세부적인 권한 관리 가능
- 강력한 보안 특성
- 확장성 우수

**단점**
- 중앙 인증 서버 구축 및 유지보수 필수
- 초기 구현 복잡도 높음
- 중앙 서버 장애 시 전체 시스템 영향
- 프로토타입 단계에 오버엔지니어링

**선택하지 않은 이유**
현재 프로젝트는 프로토타입 단계이며, 도메인별 독립 운영을 원칙으로 합니다. 중앙 인증 서버는 초기 단계에 불필요한 복잡도를 도입합니다. 향후 필요시 JWT 토큰과 호환하는 형태로 마이그레이션 가능합니다.

---

### 옵션 3: JWT (JSON Web Token) - 선택안

**설명**
클라이언트가 로그인 시 토큰을 받아 매 요청에 포함시키는 방식입니다. 토큰 자체가 사용자 정보와 서명을 포함합니다.

**장점**
- 무상태(stateless) - 도메인별 독립 운영에 이상적
- 구현이 간단하고 가볍음
- 도메인 간 신뢰성 높음 (공개키 기반 검증)
- 모바일 앱, SPA에 최적화
- 확장성 우수
- 표준 라이브러리 풍부

**단점**
- 토큰 무효화가 어려움 (블랙리스트 필요)
- 토큰 크기가 세션 ID보다 큼
- 클라이언트에서 토큰 탈취 시 주의 필요
- 권한 변경 시 즉시 반영 어려움

**선택 이유**
프로젝트 팀 아키텍처의 도메인별 독립 원칙과 완벽하게 부합합니다. 각 도메인은 공개키로 토큰을 검증하면 되며, 중앙 서버 불필요합니다. JWT는 현재 요구사항에 충분하며, 향후 OAuth로 마이그레이션도 용이합니다.

---

## 결정 내용

**채택한 옵션**: JWT (JSON Web Token)

모든 도메인의 API 인증은 JWT 토큰 기반으로 통일합니다.

### 구현 세부사항

1. **토큰 생성 (회원 도메인)**
   - 사용자 로그인 시 JWT 토큰 생성
   - Payload에 user_id, email, roles 포함
   - HS256(HMAC SHA-256) 또는 RS256(RSA) 서명

2. **토큰 검증 (모든 도메인)**
   - HTTP Authorization 헤더에서 Bearer 토큰 추출
   - 서명 검증으로 토큰 유효성 확인
   - Payload에서 user_id, roles 추출
   - 권한 검증 수행

3. **토큰 갱신**
   - Access Token: 15분 유효기간
   - Refresh Token: 7일 유효기간
   - Refresh 엔드포인트로 새 Access Token 발급

4. **도메인 간 API 호출**
   - 서비스 토큰: 도메인 간 통신용 별도 토큰
   - 서비스 ID + 서비스 Secret으로 발급

### 기술 스펙

```yaml
# JWT 토큰 구조
header:
  alg: "HS256"  # or RS256
  typ: "JWT"

payload:
  # 표준 클레임
  iss: "member-domain"        # 발급자 (도메인)
  sub: "user:12345"           # 주체 (사용자 ID)
  aud: ["api"]                # 대상 (API 서버)
  exp: 1707288000             # 만료 시간 (15분 후)
  iat: 1707287100             # 발급 시간

  # 커스텀 클레임
  user_id: 12345
  email: "user@example.com"
  name: "John Doe"
  roles: ["user", "premium"]
  domain: "member"

signature:
  # HMAC-SHA256(base64url(header) + "." + base64url(payload), secret)
```

---

## 결과 및 영향

### 긍정적 영향
- 도메인별 독립적 운영 가능 (중앙 서버 불필요)
- 마이크로서비스 환경에 최적화
- 모바일 앱/SPA에 우호적
- 구현 난이도 낮아 빠른 적용 가능
- 도메인 간 신뢰성 높음 (암호 서명)
- API 게이트웨이 도입 시에도 호환 가능

### 부정적 영향 / 주의사항
- 토큰 무효화 시 블랙리스트 관리 필요
- 권한 변경 시 최대 토큰 유효기간만큼 지연 발생 가능
- 토큰 탈취 대비 안전한 저장 필요 (HttpOnly 쿠키)
- 도메인 간 공개키 배포 메커니즘 필요

### 비용
- 개발 비용: 낮음 (표준 라이브러리 활용)
- 유지보수 비용: 낮음 (무상태이므로 확장 용이)
- 인프라 비용: 낮음 (중앙 서버 불필요)

### 마이그레이션 계획

1. **Phase 1: 회원 도메인 (T1.1-T1.3)**
   - JWT 토큰 발급 엔드포인트 구현
   - Access Token / Refresh Token 분리
   - 테스트 작성 (단위, 통합)

2. **Phase 2: 다른 도메인 (T2.1-T2.5)**
   - 모든 도메인 API에 JWT 검증 미들웨어 적용
   - 요청 인증 헤더 추가
   - CORS/프리플라이트 설정

3. **Phase 3: 통합 테스트 (T3.1)**
   - 도메인 간 API 호출 테스트
   - 권한 검증 테스트
   - 보안 테스트

4. **Phase 4: 배포 (T4.1)**
   - 프로덕션 배포
   - 클라이언트 업데이트

---

## 의존성 및 전제 조건

- **의존 ADR**: 없음 (초기 ADR)
- **기술 전제**:
  - Python 3.11+ (FastAPI)
  - Node.js 20+ (Express/NestJS)
  - 각 도메인의 공개키 배포 메커니즘 구축

- **팀 전제**:
  - 회원 도메인이 토큰 발급 역할 담당
  - 모든 도메인이 JWT 검증 라이브러리 도입

---

## 참조

### 관련 문서
- [Project Team Agents 설계](docs/design/PROJECT-TEAM-AGENTS.md)
- [회원 도메인 API 계약](contracts/interfaces/member-api.yaml)
- [API 표준 가이드](contracts/standards/api-standard.md)

### 관련 도메인
- **회원 도메인**: 토큰 발급/갱신 엔드포인트 구현
- **주문 도메인**: 회원 토큰 검증 및 권한 확인
- **상품 도메인**: 회원 토큰 검증
- **결제 도메인**: 회원 토큰 검증

### 외부 참조
- [JWT 공식 문서](https://jwt.io/)
- [RFC 7519 - JSON Web Token (JWT)](https://tools.ietf.org/html/rfc7519)
- [FastAPI Security](https://fastapi.tiangolo.com/tutorial/security/)
- [OWASP JWT 보안 가이드](https://owasp.org/www-community/attacks/jwt)

---

## 승인 히스토리

| 날짜 | 상태 | 승인자 | 비고 |
|------|------|--------|------|
| 2026-02-05 | Proposed | chief-architect | 초안 작성 |
| 2026-02-07 | Accepted | chief-architect | 승인 |

---

## 검토 기록

### 리뷰 1 - 프로젝트 매니저
- **검토자**: project-manager
- **날짜**: 2026-02-06
- **의견**: 도메인 간 협업에 적합한 선택. 구현 일정 가능할 것으로 판단.

### 리뷰 2 - 보안 담당
- **검토자**: security-specialist
- **날짜**: 2026-02-06
- **의견**: HttpOnly 쿠키 사용, 토큰 탈취 방지책 필수. 모든 API는 HTTPS 필수.
