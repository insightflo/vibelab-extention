# Database Standards

> Generated by: DBA (Phase 0 Governance Setup)
> Date: {{GENERATED_DATE}}
> Version: 1.0.0
> Database: {{DATABASE_TYPE}} (e.g., PostgreSQL, MySQL, MongoDB)

---

## 1. Table Naming Conventions

### 1.1 General Rules

| Rule | Example | Anti-Pattern |
|------|---------|--------------|
| Use `snake_case` | `user_profiles` | `userProfiles`, `UserProfiles` |
| Use plural nouns | `orders`, `products` | `order`, `product` |
| Avoid reserved words | `user_accounts` | `users` (reserved in some DBs) |
| Be descriptive | `order_line_items` | `oli`, `items` |

### 1.2 Table Prefixes (Optional)

| Prefix | Usage | Example |
|--------|-------|---------|
| None | Default (no prefix) | `users`, `orders` |
| Domain prefix | Multi-tenant/modular | `auth_users`, `billing_invoices` |
| Audit prefix | Audit tables | `audit_user_changes` |
| Archive prefix | Archive tables | `archive_orders_2024` |

### 1.3 Junction Tables (Many-to-Many)

Format: `{table1}_{table2}` in alphabetical order

| Good | Bad |
|------|-----|
| `orders_products` | `order_product_mapping` |
| `roles_users` | `user_role`, `user_roles_junction` |

---

## 2. Column Naming Conventions

### 2.1 General Rules

| Rule | Example | Anti-Pattern |
|------|---------|--------------|
| Use `snake_case` | `first_name` | `firstName`, `FirstName` |
| Be specific | `order_total_amount` | `amount`, `total` |
| Avoid abbreviations | `description` | `desc` |

### 2.2 Standard Column Patterns

| Type | Pattern | Example |
|------|---------|---------|
| Primary Key | `id` | `id` (BIGINT/UUID) |
| Foreign Key | `{referenced_table_singular}_id` | `user_id`, `order_id` |
| Boolean | `is_`, `has_`, `can_` | `is_active`, `has_paid`, `can_edit` |
| Timestamps | `_at` suffix | `created_at`, `updated_at`, `deleted_at` |
| Counts | `_count` suffix | `view_count`, `order_count` |
| Status | `_status` suffix | `order_status`, `payment_status` |

### 2.3 Required Audit Columns

Every table should include:

```sql
id              BIGINT PRIMARY KEY,         -- or UUID
created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
updated_at      TIMESTAMP NOT NULL DEFAULT NOW(),
deleted_at      TIMESTAMP NULL,             -- soft delete (if applicable)
created_by      BIGINT REFERENCES users(id),
updated_by      BIGINT REFERENCES users(id)
```

---

## 3. Index Naming Conventions

### 3.1 Index Name Patterns

| Type | Pattern | Example |
|------|---------|---------|
| Primary Key | `pk_{table}` | `pk_users` |
| Foreign Key | `fk_{table}_{column}` | `fk_orders_user_id` |
| Unique Index | `uq_{table}_{columns}` | `uq_users_email` |
| Regular Index | `idx_{table}_{columns}` | `idx_orders_created_at` |
| Composite Index | `idx_{table}_{col1}_{col2}` | `idx_orders_user_id_status` |

### 3.2 Index Guidelines

```sql
-- Good: Frequently filtered columns
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);

-- Good: Composite for common query patterns
CREATE INDEX idx_orders_user_status ON orders(user_id, status);

-- Avoid: Over-indexing (impacts write performance)
-- Avoid: Indexing boolean columns with low cardinality
```

---

## 4. Migration Standards

### 4.1 Migration File Naming

```
{timestamp}_{description}.sql

Examples:
20260208120000_create_users_table.sql
20260208130000_add_email_to_users.sql
20260208140000_create_orders_table.sql
```

### 4.2 Migration Structure

```sql
-- Migration: 20260208120000_create_users_table.sql
-- Author: {{AUTHOR}}
-- Description: Create users table with basic fields

-- UP
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    deleted_at TIMESTAMP NULL
);

CREATE UNIQUE INDEX uq_users_email ON users(email) WHERE deleted_at IS NULL;

-- DOWN (Rollback)
DROP TABLE IF EXISTS users;
```

### 4.3 Migration Safety Rules

| Rule | Reason |
|------|--------|
| Always include rollback script | Enable recovery |
| Test migration on staging first | Prevent production issues |
| Backup before large migrations | Data protection |
| Use transactions where possible | Atomicity |
| Avoid locking large tables | Uptime |

### 4.4 Zero-Downtime Migration Patterns

| Operation | Safe Pattern |
|-----------|--------------|
| Add column | Add nullable, backfill, add NOT NULL |
| Remove column | Remove from code first, then drop |
| Rename column | Add new, migrate data, remove old |
| Add index | CREATE INDEX CONCURRENTLY (PostgreSQL) |

---

## 5. Query Standards

### 5.1 Query Performance Rules

| Rule | Example |
|------|---------|
| Avoid SELECT * | `SELECT id, name, email FROM users` |
| Always use LIMIT | `SELECT ... LIMIT 100` |
| Use parameterized queries | `WHERE id = $1` (not string concat) |
| Prefer JOINs over subqueries | When possible for performance |

### 5.2 Pagination

```sql
-- Offset pagination (simple, less performant for large offsets)
SELECT * FROM orders
ORDER BY created_at DESC
LIMIT 20 OFFSET 40;

-- Cursor pagination (recommended for large datasets)
SELECT * FROM orders
WHERE created_at < '2026-02-08T10:00:00Z'
ORDER BY created_at DESC
LIMIT 20;
```

### 5.3 Preventing N+1 Queries

```sql
-- Bad: N+1 queries
SELECT * FROM orders WHERE user_id = 1;
-- Then for each order: SELECT * FROM order_items WHERE order_id = ?;

-- Good: Single query with JOIN
SELECT o.*, oi.*
FROM orders o
LEFT JOIN order_items oi ON oi.order_id = o.id
WHERE o.user_id = 1;
```

### 5.4 Transaction Guidelines

| Isolation Level | Use Case | Tradeoff |
|-----------------|----------|----------|
| READ COMMITTED | Default for most operations | Good performance |
| REPEATABLE READ | Financial transactions | Some lock contention |
| SERIALIZABLE | Critical consistency | Lower concurrency |

---

## 6. Backup & Recovery

### 6.1 Backup Schedule

| Type | Frequency | Retention | Storage |
|------|-----------|-----------|---------|
| Full Backup | Daily | 30 days | S3/GCS |
| Incremental | Hourly | 7 days | S3/GCS |
| Transaction Logs | Continuous | 7 days | S3/GCS |

### 6.2 Recovery Testing

| Test | Frequency | Success Criteria |
|------|-----------|------------------|
| Point-in-time recovery | Monthly | < 1 hour RTO |
| Full restore test | Quarterly | < 4 hours RTO |
| Failover drill | Semi-annually | < 15 min RTO |

### 6.3 Data Retention Policy

| Data Type | Retention | After Retention |
|-----------|-----------|-----------------|
| Active user data | Indefinite | N/A |
| Deleted user data | 90 days | Permanent delete |
| Audit logs | 2 years | Archive to cold storage |
| Analytics data | 1 year | Aggregate and archive |

---

## 7. Security Standards

### 7.1 Access Control

| Role | Permissions | Example |
|------|-------------|---------|
| app_read | SELECT only | Reporting services |
| app_write | SELECT, INSERT, UPDATE, DELETE | Application service |
| admin | All + DDL | Migration scripts only |

### 7.2 Sensitive Data Handling

| Data Type | Storage | Example |
|-----------|---------|---------|
| Passwords | Hash (bcrypt/argon2) | Never store plaintext |
| PII | Encrypt at rest | AES-256 |
| Payment data | Tokenize | Use payment processor |
| API keys | Hash or vault | Not in DB if possible |

### 7.3 Audit Trail

```sql
CREATE TABLE audit_log (
    id BIGSERIAL PRIMARY KEY,
    table_name VARCHAR(100) NOT NULL,
    record_id BIGINT NOT NULL,
    action VARCHAR(10) NOT NULL, -- INSERT, UPDATE, DELETE
    old_data JSONB,
    new_data JSONB,
    changed_by BIGINT REFERENCES users(id),
    changed_at TIMESTAMP NOT NULL DEFAULT NOW()
);
```

---

## 8. Monitoring & Alerts

### 8.1 Key Metrics

| Metric | Warning | Critical |
|--------|---------|----------|
| Connection pool usage | > 70% | > 90% |
| Query latency (P95) | > 100ms | > 500ms |
| Disk usage | > 70% | > 85% |
| Replication lag | > 1s | > 10s |

### 8.2 Slow Query Logging

```sql
-- PostgreSQL
ALTER SYSTEM SET log_min_duration_statement = '100ms';

-- MySQL
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 0.1;
```

---

## Change Log

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| {{DATE}} | 1.0.0 | DBA | Initial database standards |
